#!/usr/bin/env ruby
require 'nokogiri'
require 'open-uri'
require 'json'
require 'pg'
require 'sequel'

module Craigslist

  # Connect to our PostgreSQL database
  DB = Sequel.connect(ENV['DATABASE_URL'])

  # Drop the listings table for simplicity if it exists when script runs
  DB.drop_table :listings rescue puts "No listings table to drop"

  # Create the listings table
  DB.create_table :listings do
    primary_key :id
    String :title
    Float :price
    String :description
    DateTime :date
  end

  LISTINGS = DB[:listings]
  BASE_URL = "http://raleigh.craigslist.org"

  module Listing
    TITLE_SELECTOR = "#titletextonly"
    PRICE_SELECTOR = ".price"
    DESCRIPTION_SELECTOR = "#postingbody"
    DATE_SELECTOR = ".timeago"

    def self.scrape(url)
      listing_doc = Nokogiri::HTML(open(url)) # Fetch listing page

      # Remove the printer-friendly text from the description
      # that includes unecessary QR code stuff
      description = listing_doc.css(DESCRIPTION_SELECTOR)
      description.css('.print-information').remove

      listing = {
        title: listing_doc.css(TITLE_SELECTOR).text,
        price: listing_doc.css(PRICE_SELECTOR).text.gsub(/[^\d\.]/, '').to_f,
        description: description.inner_html,
        date: listing_doc.css(DATE_SELECTOR).first["datetime"],
      }

      LISTINGS.insert(listing)
    rescue
      puts "Scraping #{url} FAILED"
    end
  end

  module Search
    CATEGORY = "apa"
    SEARCH_URL = BASE_URL + "/search/" + CATEGORY
    SEARCH_RESULTS_SELECTOR = '.result-row > a'

    def self.scrape
      doc = Nokogiri::HTML(open(SEARCH_URL)) # Fetch search results page

      results = doc.css(SEARCH_RESULTS_SELECTOR) # Selects links to listings
      offset = 0

      until results.empty?
        results.each do |result|
          Listing.scrape(BASE_URL + result["href"]);
        end

        puts "Page #{offset} DONE"
        offset += 100
        doc = Nokogiri::HTML(open(SEARCH_URL + "?s=#{offset}"))
        results = doc.css(SEARCH_RESULTS_SELECTOR)
      end
    end
  end
end

Craigslist::Search.scrape
